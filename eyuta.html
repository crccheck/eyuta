<!DOCTYPE html>
<html>
<head>
<script class="jsbin" src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
<meta charset=utf-8 />
<title>Ikariam Wall Calculator</title>
<!--[if IE]>
  <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<style>
  article, aside, figure, footer, header, hgroup,
  menu, nav, section { display: block; }
  table { border-collapse: collapse; }
  td { min-width: 20px; padding: 0 2px; text-align:right; border: 1px solid gray; }
  th { min-width: 20px; padding: 0 4px;  }
  #damage { width: 3em; }
  a { font-weight: bold; text-decoration: none; color: white; background: black; width: 1em; display: inline-block; text-align: center; }
  .hop { background-color: #FFFFAE; }
  .sg { background-color: #FF9696; }
  .sword { background-color: cyan; }
  .spear { background-color: #A5E0B0; }
</style>
</head>
<body>
  <table style="float: right;">
    <tr><th>Front Line</th><th>HP</th></tr>
    <tr><td class="hop">Hoplite</td><td>56</td></tr>
    <tr><td class="sg">Steam Giant</td><td>184</td></tr>
    <tr><td class="sword">Swordsman</td><td>18</td></tr>
    <tr><td class="spear">Spearman</td><td>13</td></tr>
  </table>
  <input type="radio" name="mode" value="inactive" id="inactive" checked><label for="inactive">inactive</label>
  <input type="radio" name="mode" value="active" id="active"><label for="active">active</label><br/>
  <input type="radio" name="artillery" value="mortar" id="mortar" checked><label for="mortar">Mortar</label>
  <input type="radio" name="artillery" value="catapult" id="catapult"><label for="catapult">Catapult</label>
  <input type="radio" name="artillery" value="ram" id="ram"><label for="ram">Ram</label><br>
  <input type="radio" name="upgrade" value="0" id="base"><label for="base">Base</label>
  <input type="radio" name="upgrade" value="1" id="bronze"><label for="bronze">Bronze</label>
  <input type="radio" name="upgrade" value="2" id="silver"><label for="silver">Silver</label>
  <input type="radio" name="upgrade" value="3" id="gold" checked><label for="gold">Gold</label><br>
  <label>Damage: </label><input type="text" readonly value="" id="damage"><br>
  <label for="count">Specify #:</label> <a id="dec" href="#">&ndash;</a> <input type="text" id="count" size="2"> <a id="inc" href="#">+</a> (1 - 18)<br>
  <table id="main">
    <thead><tr><th>level</th><th>hp</th><th>armor</th>
      <th>attack</th>
      <th>rounds</th><th>#</th><th>losses</th>
      <th>damage</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <p>Ammo not taken into account</p>
</body>
<script>
var artillery = {
  mortar:[322, 323, 324, 325],
  catapult:[133,134,135,136],
  ram: [76,77,78,79],
};

function Wall(level,vs){
  this.rounds = function(count){
    count = count || 18;
    return Math.ceil(7*this.hitsPerSection/count);
  }
  this.simulate = function(n,sections,round){
    if (mode == 'active' && (sections == 0 || this.dmgRecieved == 0))
      return {
        remain  : 0,
        sections: 0,
        history : [],
        rounds  : round
      };
    else if (mode == 'inactive' && (sections <= 6 || this.dmgRecieved == 0))
      return {
        remain  : 0,
        sections: 0,
        history : [],
        rounds  : round
      };
    else {
      sections = sections || 7;
      n = n || 18;
      round = round || 0;
      var remain = Math.max(sections-n/this.hitsPerSection,0);
      var nextRound = this.simulate(n,remain,round+1);
      nextRound.history.unshift(Math.ceil(remain));
      return {
        remain   : remain,
        sections : Math.ceil(remain)+nextRound.sections,
        history  : nextRound.history,
        rounds   : nextRound.rounds
      };
    }
  }
  this.minArtillery = function(){
    var base = this.simulate(18).sections;
    if (this.hitsPerSection > 3) return 18; // limited ammo for mortars
    console.log(this.level,mode,base);
    for (var i = 17; i >= 7; --i){
      if (this.simulate(i).sections > base) break;
    }
    return i + 1;
  }
  this.level = level;
  this.armor = 15+8*Math.floor(level/3);
  this.hp    = 100+50*level;
  this.dmgRecieved = Math.max(vs - this.armor,0);
  this.hitsPerSection = Math.ceil(this.hp/this.dmgRecieved);
  this.attack = 50 + 10 * this.level;
  if (this.level < 20) this.attack = 30 + 5 * this.level;
  if (this.level < 10) this.attack = 10 + 2 * this.level;
}

function calculate(dmg){
  dmg = dmg || artillery.mortar[3];
  $('#damage').val(dmg);
  var output = '';
  var count = $('#count').val();
  for (var i = 1; i <= 35; ++i){
    var wall = new Wall(i,dmg);
    var min = !count || isNaN(count) ? wall.minArtillery() : count;
    var simulation = wall.simulate(min);
    var frontLine = '';
    var total_dmg = simulation.sections * wall.attack;
    if (total_dmg < 13) frontLine = 'spear';
    else if (total_dmg < 18) frontLine = 'sword';
    else if (total_dmg < 56) frontLine = 'hop';
    else if (total_dmg < 184) frontLine = 'sg';
    else                      frontLine = 'spear';
    output += '<tr><th>'+[
      i,
      wall.hp, wall.armor,
      wall.attack,
      simulation.rounds,
      min,
      simulation.history.join(' + ') + ' = ' + simulation.sections,
      '<div class="'+frontLine+'">'+total_dmg + '</div>'
    ].join('<td>');
    delete wall;
  }
  $("#main > tbody").html(output);
}

function run(){
  mode = $('input[name=mode]:checked').val();
  var type = $('input[name=artillery]:checked').val() || 'mortar';
  var upgrade = $('input[name=upgrade]:checked').val() || 0;
  calculate(artillery[type][upgrade]);
}

var mode = 'inactive';
$(function(){
  $('#dec').click(function(){
    var count = $('#count').val();
    if (count == '') count = 17;
    else if (count == 1) count = 1;
    else --count;
    $('#count').val(count);
    run();
    return false;
  });
  $('#inc').click(function(){
    var count = $('#count').val();
    if (count == '') count = 1;
    else if (count == 18) count = 18;
    else ++count;
    $('#count').val(count);
    run();
    return false;
  });
  calculate();
  $('input').click(run);
  $('#count').change(run);
})
</script>
</html>